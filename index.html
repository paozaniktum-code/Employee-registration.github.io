<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    
    .shift-cell {
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-size: 12px;
    }
    
    .shift-cell:hover {
      transform: scale(1.1);
      z-index: 20;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .shift-d {
      background-color: #fef3c7; /* Amber 100 */
      color: #92400e; /* Amber 800 */
      font-weight: 700;
      border: 1px solid #fcd34d;
    }
    
    .shift-n {
      background-color: #dbeafe; /* Blue 100 */
      color: #1e40af; /* Blue 800 */
      font-weight: 700;
      border: 1px solid #93c5fd;
    }
    
    .shift-empty {
      background-color: #f9fafb;
      color: #d1d5db;
    }

    .shift-empty:hover {
        background-color: #e5e7eb;
    }
    
    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 250px); /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠ */
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
    }
    
    table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    th {
      position: sticky;
      top: 0;
      background-color: #1e3a8a;
      color: white;
      z-index: 10;
      padding: 10px;
      font-size: 14px;
      white-space: nowrap;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
    }
    
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      z-index: 11;
      background-color: #f8fafc;
      border-right: 2px solid #e2e8f0;
    }
    
    th:first-child {
      z-index: 20;
      background-color: #1e3a8a;
      color: white;
    }

    td {
        white-space: nowrap;
        font-size: 13px;
    }
    
    .action-btn {
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Modal Animation */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-animate {
        animation: fadeIn 0.2s ease-out;
    }
  </style>
 </head>
 <body class="h-full bg-gray-50">
  <div class="h-full w-full flex flex-col">
   
   <div class="bg-white shadow-sm p-4 z-30">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-blue-900">üìÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
            <p class="text-sm text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏∞: ‡∏ß‡πà‡∏≤‡∏á ‚ûù <span class="text-amber-700 font-bold">D</span> ‚ûù <span class="text-blue-800 font-bold">N</span></p>
        </div>
        
        <div class="flex items-center gap-3 bg-blue-50 p-2 rounded-lg">
            <label for="month-select" class="text-sm font-bold text-blue-800">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label> 
            <select id="month-select" class="px-3 py-1 border border-blue-200 rounded text-blue-900 font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"> 
                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option> <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option> <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option> 
                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option> <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option> <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option> 
                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option> <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option> <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option> 
                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option> <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option> <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option> 
            </select>
            <span id="days-count" class="text-xs text-gray-500 font-medium bg-white px-2 py-1 rounded border">31 ‡∏ß‡∏±‡∏ô</span>
        </div>

        <div class="flex gap-2">
            <button onclick="document.getElementById('add-modal').classList.remove('hidden')" class="action-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 shadow-sm flex items-center gap-2">
                <span>+ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
            </button>
            <button id="print-report-btn" class="action-btn bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 shadow-sm flex items-center gap-2">
                <span>üñ®Ô∏è ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
            </button>
            <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-600 underline ml-2">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
   </div>

   <div class="flex-1 overflow-hidden p-4">
     <div id="table-container" class="table-wrapper bg-white shadow-lg h-full">
      <table class="w-full">
       <thead>
        <tr>
         <th class="text-center w-12">‡∏ó‡∏µ‡πà</th>
         <th class="text-left w-48">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
         <th class="p-0" id="days-header">
            </th>
         <th class="text-right w-24">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
         <th class="text-right w-20">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏ß‡∏±‡∏ô</th>
         <th class="text-center w-16">‡πÄ‡∏ß‡∏£</th>
         <th class="text-right w-24 bg-blue-50 text-blue-900">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
         <th class="text-right w-20">OT</th>
         <th class="text-right w-20">‡∏≠‡∏∑‡πà‡∏ô‡πÜ(+)</th>
         <th class="text-right w-20 text-red-200">‡∏´‡∏±‡∏Å(-)</th>
         <th class="text-right w-28 bg-green-50 text-green-900">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
         <th class="text-center w-16">‡∏•‡∏ö</th>
        </tr>
       </thead>
       <tbody id="employee-tbody">
        </tbody>
      </table>
      
      <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 pb-20">
        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <p class="text-lg font-medium">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
        <p class="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "+ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      </div>
     </div>
   </div>

   <div id="add-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-animate backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-blue-900 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
      <form id="add-employee-form" class="space-y-4">
       <div>
           <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> 
           <input type="text" id="employee-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
       </div>
       <div>
           <label class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label> 
           <input type="number" id="base-salary" required min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15000">
       </div>
       <div class="flex gap-3 pt-2">
           <button type="button" onclick="document.getElementById('add-modal').classList.add('hidden')" class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
           <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
       </div>
      </form>
    </div>
   </div>

   <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-animate backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
     <h3 class="text-xl font-bold text-blue-900 mb-4" id="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
     <form id="edit-form" class="space-y-4">
      <input type="hidden" id="edit-id">
      <input type="hidden" id="edit-field">
      <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1" id="edit-label">‡∏Ñ‡πà‡∏≤</label> 
          <input type="number" id="edit-value" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-lg font-bold text-blue-800 text-center">
      </div>
      <div class="flex gap-3 pt-2">
          <button type="button" id="cancel-edit" class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 shadow-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
     </form>
    </div>
   </div>
  </div>

  <script>
    // --- Mock Database (LocalStorage) ---
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á Database ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Server
    const DB_KEY = 'shift_app_db_v2';
    
    const db = {
        read: () => {
            const data = localStorage.getItem(DB_KEY);
            return data ? JSON.parse(data) : [];
        },
        save: (data) => {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
        },
        create: (emp) => {
            const data = db.read();
            emp.id = Date.now().toString(); // Generate unique ID
            data.push(emp);
            db.save(data);
            return emp;
        },
        update: (emp) => {
            const data = db.read();
            const index = data.findIndex(e => e.id === emp.id);
            if (index !== -1) {
                data[index] = emp;
                db.save(data);
                return true;
            }
            return false;
        },
        delete: (id) => {
            let data = db.read();
            data = data.filter(e => e.id !== id);
            db.save(data);
            return true;
        }
    };

    // --- App Logic ---
    let employees = [];
    let currentMonth = new Date().getMonth() + 1; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let currentYear = new Date().getFullYear();
    let daysInMonth = 31;
    
    const daysPerMonth = {
      1: 31, 2: 28, 3: 31, 4: 30, 5: 31, 6: 30,
      7: 31, 8: 31, 9: 30, 10: 31, 11: 30, 12: 31
    };

    // Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏≠‡∏ò‡∏¥‡∏Å‡∏™‡∏∏‡∏£‡∏ó‡∏¥‡∏ô (Leap Year) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå
    function getDaysInMonth(month, year) {
        if (month === 2) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0) ? 29 : 28;
        }
        return daysPerMonth[month];
    }

    // Initial Load
    window.addEventListener('load', () => {
        // Set dropdown to current month
        const monthSelect = document.getElementById('month-select');
        monthSelect.value = currentMonth;
        
        employees = db.read();
        updateMonthConfig();
        renderEmployeeTable();
        
        // Listeners
        monthSelect.addEventListener('change', (e) => {
            currentMonth = parseInt(e.target.value);
            updateMonthConfig();
            renderEmployeeTable();
        });
    });

    function updateMonthConfig() {
        daysInMonth = getDaysInMonth(currentMonth, currentYear);
        document.getElementById('days-count').textContent = `${daysInMonth} ‡∏ß‡∏±‡∏ô`;
        generateDaysHeader();
    }

    function generateDaysHeader() {
      const header = document.getElementById('days-header');
      let html = '<div class="flex">';
      for (let i = 1; i <= daysInMonth; i++) {
        // Highlight weekends roughly (not exact calendar but visual aid)
        html += `<div class="border-r border-blue-800 text-center text-xs flex items-center justify-center bg-blue-900" style="min-width: 32px; height: 40px;">${i}</div>`;
      }
      html += '</div>';
      header.innerHTML = html;
    }

    // Shift Logic: 'D' -> 'N' -> ''
    function getNextShift(current) {
        if (!current) return 'D';
        if (current === 'D') return 'N';
        return '';
    }

    // Get shifts for current month
    function getMonthShifts(emp) {
        if (!emp.shifts) return Array(32).fill(''); // Index 1-31
        
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (String) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (Object ‡πÅ‡∏¢‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        if (typeof emp.shifts === 'string') {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß Migrate
            return emp.shifts.split(',');
        } else {
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Object: { "1": "...,...", "2": "..." }
            const monthKey = currentMonth.toString();
            if (emp.shifts[monthKey]) {
                return emp.shifts[monthKey].split(',');
            }
            return Array(32).fill('');
        }
    }

    function calculateStats(emp) {
        const shifts = getMonthShifts(emp);
        const shiftCount = shifts.filter(s => s === 'D' || s === 'N').length;
        const daysOff = daysInMonth - shiftCount;
        const dailyRate = (emp.base_salary || 0) / daysInMonth;
        const totalWage = dailyRate * shiftCount;
        
        // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        const income = (emp.overtime || 0) + (emp.sales_percent || 0) + (emp.cases_completed || 0);
        
        // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å
        const deductions = (emp.uniform_cost || 0) + (emp.training_cost || 0) + 
                          (emp.utilities_cost || 0) + (emp.violation_cost || 0) + (emp.other_cost || 0);
                          
        const netTotal = totalWage + income - deductions;

        return { shiftCount, dailyRate, totalWage, income, deductions, netTotal, daysOff };
    }

    function renderEmployeeTable() {
      const tbody = document.getElementById('employee-tbody');
      const emptyState = document.getElementById('empty-state');
      const tableContainer = document.getElementById('table-container');
      
      if (employees.length === 0) {
        tbody.innerHTML = '';
        tableContainer.classList.add('flex', 'flex-col'); // For centering empty state
        emptyState.classList.remove('hidden');
        return;
      }
      
      tableContainer.classList.remove('flex', 'flex-col');
      tableContainer.classList.add('block');
      emptyState.classList.add('hidden');
      
      tbody.innerHTML = employees.map((emp, index) => {
        const shifts = getMonthShifts(emp);
        const stats = calculateStats(emp);
        
        // Generate Shift Cells
        const shiftCells = [];
        for (let i = 0; i < daysInMonth; i++) { // 0 to days-1
            const shift = shifts[i] || ''; // Array index 0 = Day 1
            const cellClass = shift === 'D' ? 'shift-d' : shift === 'N' ? 'shift-n' : 'shift-empty';
            
            shiftCells.push(
                `<div class="shift-cell ${cellClass} border-r border-b border-gray-200 text-center" 
                      style="min-width: 32px; height: 32px; line-height: 32px;"
                      onclick="toggleShift('${emp.id}', ${i})">
                      ${shift}
                 </div>`
            );
        }
        
        return `
          <tr class="hover:bg-blue-50 transition-colors bg-white">
            <td class="p-2 border-b border-r text-center bg-gray-50 font-bold text-gray-500 sticky left-0 z-10">${index + 1}</td>
            <td class="p-2 border-b border-r font-semibold text-blue-900 sticky left-12 z-10 bg-white" style="left: 48px;">
                <div class="truncate w-40" title="${emp.employee_name}">${emp.employee_name}</div>
            </td>
            <td class="p-0 border-b border-r">
              <div class="flex">${shiftCells.join('')}</div>
            </td>
            <td class="p-2 border-b border-r text-right cursor-pointer hover:bg-yellow-50 text-gray-600" onclick="openEdit('${emp.id}', 'base_salary')">
              ${formatMoney(emp.base_salary)}
            </td>
            <td class="p-2 border-b border-r text-right text-gray-400 text-xs">
              ${formatMoney(stats.dailyRate)}
            </td>
            <td class="p-2 border-b border-r text-center font-bold bg-gray-50">
              ${stats.shiftCount}
            </td>
            <td class="p-2 border-b border-r text-right font-bold text-blue-700 bg-blue-50">
              ${formatMoney(stats.totalWage)}
            </td>
            <td class="p-2 border-b border-r text-right cursor-pointer hover:bg-yellow-50 text-green-600 font-semibold" onclick="openEdit('${emp.id}', 'overtime')">
              ${formatMoney(emp.overtime)}
            </td>
            <td class="p-2 border-b border-r text-right text-green-600 text-xs cursor-pointer hover:bg-yellow-50" 
                onclick="openEdit('${emp.id}', 'sales_percent')" 
                title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°/‡∏à‡∏ö‡πÄ‡∏Ñ‡∏™">
              +${formatMoney((emp.sales_percent||0) + (emp.cases_completed||0))}
            </td>
            <td class="p-2 border-b border-r text-right text-red-500 text-xs cursor-pointer hover:bg-yellow-50" 
                onclick="openEdit('${emp.id}', 'uniform_cost')"
                title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÜ">
              -${formatMoney(stats.deductions)}
            </td>
            <td class="p-2 border-b border-r text-right font-bold text-white ${stats.netTotal >= 0 ? 'bg-green-500' : 'bg-red-500'}">
              ${formatMoney(stats.netTotal)}
            </td>
            <td class="p-2 border-b text-center">
              <button onclick="deleteEmployee('${emp.id}')" class="text-gray-400 hover:text-red-500 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function formatMoney(num) {
        return (num || 0).toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    // --- Actions ---

    function toggleShift(id, dayIndex) {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;

        let shifts = getMonthShifts(emp);
        const currentVal = shifts[dayIndex] || '';
        shifts[dayIndex] = getNextShift(currentVal);

        // Save logic: Ensure structure is object per month
        if (typeof emp.shifts === 'string' || !emp.shifts) {
            emp.shifts = {};
        }
        
        emp.shifts[currentMonth.toString()] = shifts.join(',');
        
        db.update(emp);
        employees = db.read(); // refresh local state
        renderEmployeeTable();
    }

    document.getElementById('add-employee-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('employee-name').value.trim();
        const salary = parseFloat(document.getElementById('base-salary').value);
        
        if (!name || isNaN(salary)) return;

        const newEmp = {
            employee_name: name,
            base_salary: salary,
            shifts: {}, // New structure
            overtime: 0, sales_percent: 0, cases_completed: 0,
            uniform_cost: 0, training_cost: 0, utilities_cost: 0, violation_cost: 0, other_cost: 0,
            created_at: new Date().toISOString()
        };

        db.create(newEmp);
        employees = db.read();
        renderEmployeeTable();
        document.getElementById('add-employee-form').reset();
        document.getElementById('add-modal').classList.add('hidden');
    });

    function deleteEmployee(id) {
        if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£')) {
            db.delete(id);
            employees = db.read();
            renderEmployeeTable();
        }
    }

    // --- Editing System ---
    const fieldMapping = {
        'base_salary': '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ê‡∏≤‡∏ô',
        'overtime': '‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (OT)',
        'sales_percent': '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô / %‡∏Ç‡∏≤‡∏¢',
        'uniform_cost': '‡∏Ñ‡πà‡∏≤‡∏ä‡∏∏‡∏î / ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏´‡∏±‡∏Å)',
        'training_cost': '‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏´‡∏±‡∏Å)',
        'utilities_cost': '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü (‡∏´‡∏±‡∏Å)',
        'violation_cost': '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö/‡∏ú‡∏¥‡∏î‡∏Å‡∏é (‡∏´‡∏±‡∏Å)',
        'other_cost': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏´‡∏±‡∏Å)'
    };

    function openEdit(id, field) {
        // Special logic for grouping fields if needed, but for now simple 1-1
        // If clicking 'sales_percent' we might want to show both sales & cases in a real app, 
        // but let's keep it simple: Just edit the clicked field mostly.
        // For the grouped columns, we'll default to editing the main one.
        
        const emp = employees.find(e => e.id === id);
        if (!emp) return;

        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏Å) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ó‡∏≥ simple ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏ä‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥ dropdown)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏° -> ‡πÅ‡∏Å‡πâ "‡∏Ñ‡πà‡∏≤‡∏ä‡∏∏‡∏î" (user can create more specific UI later)
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ -> ‡πÅ‡∏Å‡πâ "‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°"
        
        let targetField = field;
        
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-field').value = targetField;
        document.getElementById('edit-label').textContent = fieldMapping[targetField] || targetField;
        document.getElementById('edit-value').value = emp[targetField] || 0;
        
        document.getElementById('edit-modal').classList.remove('hidden');
        document.getElementById('edit-value').focus();
        document.getElementById('edit-value').select();
    }

    document.getElementById('edit-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const field = document.getElementById('edit-field').value;
        const value = parseFloat(document.getElementById('edit-value').value);
        
        const emp = employees.find(e => e.id === id);
        if (emp) {
            emp[field] = value;
            db.update(emp);
            employees = db.read();
            renderEmployeeTable();
            document.getElementById('edit-modal').classList.add('hidden');
        }
    });

    document.getElementById('cancel-edit').addEventListener('click', () => {
        document.getElementById('edit-modal').classList.add('hidden');
    });

    function resetData() {
        if(confirm('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö! ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }

    // --- Printing ---
    document.getElementById('print-report-btn').addEventListener('click', () => {
        // Simple Print Logic
        const printWindow = window.open('', '', 'width=1000,height=800');
        const monthName = document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text;
        
        let rows = '';
        let totalSum = 0;

        employees.forEach((emp, i) => {
            const stats = calculateStats(emp);
            totalSum += stats.netTotal;
            rows += `
                <tr>
                    <td style="text-align:center">${i+1}</td>
                    <td>${emp.employee_name}</td>
                    <td style="text-align:right">${formatMoney(emp.base_salary)}</td>
                    <td style="text-align:center">${stats.shiftCount}</td>
                    <td style="text-align:right">${formatMoney(stats.totalWage)}</td>
                    <td style="text-align:right">${formatMoney(stats.income)}</td>
                    <td style="text-align:right; color:red;">-${formatMoney(stats.deductions)}</td>
                    <td style="text-align:right; font-weight:bold;">${formatMoney(stats.netTotal)}</td>
                </tr>
            `;
        });

        printWindow.document.write(`
            <html>
            <head>
                <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ${monthName}</title>
                <style>
                    body { font-family: sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                    h1 { text-align: center; color: #1e3a8a; }
                    .footer { margin-top: 30px; text-align: right; font-weight: bold; font-size: 16px; }
                </style>
            </head>
            <body>
                <h1>‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName}</h1>
                <table>
                    <thead>
                        <tr>
                            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ê‡∏≤‡∏ô</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£</th>
                            <th>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏£</th>
                            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (OT/Com)</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å</th>
                            <th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="footer">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${formatMoney(totalSum)} ‡∏ö‡∏≤‡∏ó</div>
                <script>window.print();<\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    });

  </script>
 </body>
</html>
