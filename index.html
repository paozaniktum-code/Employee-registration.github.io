<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Excel Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-4">

<div class="max-w-7xl mx-auto bg-white shadow rounded-xl p-4">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <h1 class="text-xl font-bold">üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>

    <div class="flex gap-2">
      <button id="export-btn" data-admin-only
        class="px-4 py-2 bg-green-600 text-white rounded-lg">Export Excel</button>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="border px-2">D Rate</th>
          <th class="border px-2">N Rate</th>
          <th class="border px-2">‡πÄ‡∏ß‡∏£</th>
          <th class="border px-2">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</th>
          <th class="border px-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
        </tr>
      </thead>
      <tbody id="employee-body"></tbody>
    </table>
  </div>

  <!-- Monthly Summary -->
  <div id="monthly-summary" class="mt-4 text-sm font-semibold"></div>

</div>

<script>
/**********************
 * AUTH / ROLE
 **********************/
const currentUser = { username: 'admin', role: 'admin' }; // admin | user
const isAdmin = () => currentUser.role === 'admin';

function applyPermission() {
  document.querySelectorAll('[data-admin-only]').forEach(el => {
    el.disabled = !isAdmin();
    el.classList.toggle('opacity-50', !isAdmin());
  });
}

/**********************
 * DATA
 **********************/
let employees = JSON.parse(localStorage.getItem('employees')) || [
  {
    id: 1,
    employee_name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
    day_rate_d: 500,
    day_rate_n: 700,
    shifts: 'D,N,D,,N',
    overtime: 0,
    sales_percent: 0,
    cases_completed: 0,
    uniform_cost: 0,
    training_cost: 0,
    utilities_cost: 0,
    violation_cost: 0,
    other_cost: 0
  }
];

function save() {
  localStorage.setItem('employees', JSON.stringify(employees));
}

/**********************
 * SHIFT UTILS
 **********************/
function parseShifts(str) {
  return str.split(',');
}

function calculateShiftCount(shifts) {
  return shifts.filter(s => s === 'D' || s === 'N').length;
}

function calculateTotalWage(shifts, rateD, rateN) {
  return shifts.reduce((sum, s) => {
    if (s === 'D') return sum + rateD;
    if (s === 'N') return sum + rateN;
    return sum;
  }, 0);
}

function calculateRemaining(emp, shifts) {
  const wage = calculateTotalWage(shifts, emp.day_rate_d, emp.day_rate_n);
  const income = wage + emp.overtime + emp.sales_percent + emp.cases_completed;
  const deductions = emp.uniform_cost + emp.training_cost + emp.utilities_cost + emp.violation_cost + emp.other_cost;
  return income - deductions;
}

/**********************
 * SUMMARY
 **********************/
function calculateEmployeeSummary(emp) {
  const shifts = parseShifts(emp.shifts);
  return {
    shifts: calculateShiftCount(shifts),
    wage: calculateTotalWage(shifts, emp.day_rate_d, emp.day_rate_n),
    net: calculateRemaining(emp, shifts)
  };
}

function calculateMonthlySummary(list) {
  return list.reduce((sum, emp) => {
    const s = calculateEmployeeSummary(emp);
    sum.shifts += s.shifts;
    sum.wage += s.wage;
    sum.net += s.net;
    return sum;
  }, { shifts: 0, wage: 0, net: 0 });
}

/**********************
 * RENDER
 **********************/
function render() {
  const tbody = document.getElementById('employee-body');
  tbody.innerHTML = '';

  employees.forEach(emp => {
    const shifts = parseShifts(emp.shifts);
    const wage = calculateTotalWage(shifts, emp.day_rate_d, emp.day_rate_n);
    const net = calculateRemaining(emp, shifts);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-2">${emp.employee_name}</td>
      <td class="border px-2 text-right">${emp.day_rate_d}</td>
      <td class="border px-2 text-right">${emp.day_rate_n}</td>
      <td class="border px-2 text-center">${calculateShiftCount(shifts)}</td>
      <td class="border px-2 text-right text-green-600">${wage.toLocaleString()}</td>
      <td class="border px-2 text-right font-bold">${net.toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });

  const summary = calculateMonthlySummary(employees);
  document.getElementById('monthly-summary').innerText =
    `‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏£: ${summary.shifts} | ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏£‡∏ß‡∏°: ${summary.wage.toLocaleString()} | ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${summary.net.toLocaleString()}`;

  applyPermission();
}

/**********************
 * EXCEL EXPORT
 **********************/
function exportExcel() {
  const data = employees.map((emp, i) => {
    const shifts = parseShifts(emp.shifts);
    return {
      ‡∏•‡∏≥‡∏î‡∏±‡∏ö: i + 1,
      ‡∏ä‡∏∑‡πà‡∏≠: emp.employee_name,
      ‡πÄ‡∏ß‡∏£: calculateShiftCount(shifts),
      ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á: calculateTotalWage(shifts, emp.day_rate_d, emp.day_rate_n),
      ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: calculateRemaining(emp, shifts)
    };
  });

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
  XLSX.writeFile(wb, 'payroll.xlsx');
}

/**********************
 * INIT
 **********************/
document.getElementById('export-btn').onclick = exportExcel;
render();
</script>

</body>
</html>
