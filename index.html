<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .branch-card { transition: all 0.2s; cursor: pointer; }
    .branch-card:hover { transform: translateY(-5px); shadow: 0 10px 15px rgba(0,0,0,0.1); }
    
    .shift-cell { cursor: pointer; user-select: none; font-size: 12px; height: 32px; min-width: 30px; border-right: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; }
    .shift-d { background-color: #fef3c7; color: #92400e; font-weight: 700; }
    .shift-n { background-color: #dbeafe; color: #1e40af; font-weight: 700; }
    .shift-x { background-color: #fecaca; color: #b91c1c; font-weight: 700; }
    .shift-dn { background-color: #a78bfa; color: #312e81; font-weight: 700; border: 1px dashed #6d28d9; }
    .shift-empty { background-color: #f9fafb; color: #d1d5db; }

    .table-wrapper { overflow: auto; max-height: calc(100vh - 280px); border: 1px solid #e5e7eb; border-radius: 0.5rem; }
    table { border-collapse: separate; border-spacing: 0; min-width: 1600px; }
    th { position: sticky; top: 0; background-color: #1e3a8a; color: white; z-index: 10; white-space: nowrap; padding: 8px; }
    
    th:first-child, td:first-child { position: sticky; left: 0; z-index: 12; background-color: #1e3a8a; color: white; min-width: 70px; }
    th:nth-child(2), td:nth-child(2) { position: sticky; left: 70px; z-index: 12; background-color: #1e3a8a; color: white; min-width: 180px; }
    th:nth-child(3), td:nth-child(3) { position: sticky; left: 250px; z-index: 12; background-color: #1e3a8a; color: white; min-width: 120px; }
    td:nth-child(3) { background-color: white !important; color: black; z-index: 11; }

    .hidden-view { display: none !important; }
  </style>
 </head>
 <body class="h-full bg-gray-50">

  <div id="branch-selection-page" class="h-screen flex flex-col items-center justify-center p-6">
    <h1 class="text-3xl font-bold text-blue-900 mb-8 text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
        <div onclick="enterBranch(1)" class="branch-card bg-white p-8 rounded-xl shadow-md border-t-4 border-blue-600 text-center">
            <span class="text-4xl">üè™</span>
            <h2 class="text-xl font-bold mt-4">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà 1</h2>
            <p class="text-gray-500 text-sm mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
        </div>
        <div onclick="enterBranch(2)" class="branch-card bg-white p-8 rounded-xl shadow-md border-t-4 border-emerald-600 text-center">
            <span class="text-4xl">üè¨</span>
            <h2 class="text-xl font-bold mt-4">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà 2</h2>
            <p class="text-gray-500 text-sm mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
        </div>
    </div>
  </div>

  <div id="main-app-page" class="hidden-view h-full flex flex-col">
   <div class="p-4 md:p-6 shadow-md bg-white flex-none z-20">
    <header class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
     <div>
         <div class="flex items-center gap-3">
            <button onclick="goBack()" class="text-blue-600 hover:underline text-sm font-bold">‚Üê ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤</button>
            <h1 id="branch-display-title" class="text-3xl font-bold text-blue-900"></h1>
         </div>
         <p class="text-sm text-gray-600">
            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏ô‡∏Å‡∏∞: ‡∏ß‡πà‡∏≤‡∏á ‚ûù D ‚ûù N ‚ûù <span class="text-violet-900 font-bold">DN</span> ‚ûù <span class="text-red-700 font-bold">X</span>
            <br>
            <span class="font-semibold text-blue-700">üìå ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏´‡∏±‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î 4 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß | ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£‡∏à‡∏£‡∏¥‡∏á</span>
        </p>
     </div>
     <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
         <div class="flex items-center gap-3 bg-blue-50 p-2 rounded-lg border border-blue-200">
             <label class="block text-sm font-semibold text-blue-800">‡∏õ‡∏µ ‡∏û.‡∏®.:</label>
             <select id="year-select" class="px-3 py-1 border border-blue-300 rounded text-blue-900 font-semibold focus:ring-2 focus:ring-blue-500"></select>
             <label class="block text-sm font-semibold text-blue-800">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label> 
             <select id="month-select" class="px-3 py-1 border border-blue-300 rounded text-blue-900 font-semibold focus:ring-2 focus:ring-blue-500"> 
                 <option value="1">‡∏°.‡∏Ñ.</option><option value="2">‡∏Å.‡∏û.</option><option value="3">‡∏°‡∏µ.‡∏Ñ.</option> 
                 <option value="4">‡πÄ‡∏°.‡∏¢.</option><option value="5">‡∏û.‡∏Ñ.</option><option value="6">‡∏°‡∏¥.‡∏¢.</option> 
                 <option value="7">‡∏Å.‡∏Ñ.</option><option value="8">‡∏™.‡∏Ñ.</option><option value="9">‡∏Å.‡∏¢.</option> 
                 <option value="10">‡∏ï.‡∏Ñ.</option><option value="11">‡∏û.‡∏¢.</option><option value="12">‡∏ò.‡∏Ñ.</option> 
             </select>
             <span id="days-display" class="text-xs text-gray-600 font-medium bg-white px-2 py-1 rounded border">31 ‡∏ß‡∏±‡∏ô</span>
         </div>
         <button id="print-report-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 shadow-md">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
     </div>
    </header>
    
    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
     <form id="add-employee-form" class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div>
          <label class="block text-xs font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> 
          <input type="text" id="employee-name" required class="w-full px-3 py-2 border rounded-lg text-sm">
      </div>
      <div>
          <label class="block text-xs font-bold text-gray-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label> 
          <input type="text" id="employee-position" required class="w-full px-3 py-2 border rounded-lg text-sm">
      </div>
      <div>
          <label class="block text-xs font-bold text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label> 
          <select id="employee-type" class="w-full px-3 py-2 border rounded-lg text-sm bg-white font-bold">
              <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏´‡∏±‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î 4 ‡∏ß‡∏±‡∏ô)</option>
              <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)</option>
          </select>
      </div>
      <div>
          <label class="block text-xs font-bold text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label> 
          <input type="number" id="base-salary" required class="w-full px-3 py-2 border rounded-lg text-sm">
      </div>
      <div class="flex items-end">
          <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 h-10 shadow-md">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
      </div>
     </form>
    </div>
   </div>

   <div class="flex-1 px-4 md:px-6 pb-6 overflow-hidden flex flex-col">
    <div class="table-wrapper bg-white shadow-lg mt-4">
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
         <th id="days-header"></th>
         <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á/‡∏ß‡∏±‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏£</th>
         <th class="bg-blue-800">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th><th>‡πÇ‡∏≠‡∏ó‡∏µ</th><th>‡∏´‡∏¢‡∏∏‡∏î</th><th>%‡∏Ç‡∏≤‡∏¢</th>
         <th class="bg-red-700">‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏°</th><th class="bg-green-700">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="employee-tbody"></tbody>
      </table>
    </div>
   </div>
  </div>

  <script>
    let currentBranch = 1;
    let employees = [];
    let currentADYear = new Date().getFullYear();
    let currentThaiYear = currentADYear + 543;
    let selectedMonth = new Date().getMonth() + 1;
    let selectedYear = currentThaiYear;

    const getDBKey = (branch) => `shift_system_branch_${branch}_v12`;

    window.onload = () => {
        const yearSelect = document.getElementById('year-select');
        for(let i = currentThaiYear - 1; i <= currentThaiYear + 3; i++) {
            const opt = document.createElement('option');
            opt.value = i; opt.textContent = i;
            yearSelect.appendChild(opt);
        }
        document.getElementById('month-select').value = selectedMonth;
        yearSelect.value = selectedYear;
        
        document.getElementById('month-select').onchange = (e) => { selectedMonth = parseInt(e.target.value); renderAll(); };
        document.getElementById('year-select').onchange = (e) => { selectedYear = parseInt(e.target.value); renderAll(); };
    };

    function enterBranch(branchNum) {
        currentBranch = branchNum;
        document.getElementById('branch-selection-page').classList.add('hidden-view');
        document.getElementById('main-app-page').classList.remove('hidden-view');
        document.getElementById('branch-display-title').textContent = `üìÖ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà ${branchNum}`;
        employees = JSON.parse(localStorage.getItem(getDBKey(currentBranch)) || '[]');
        renderAll();
    }

    function goBack() {
        document.getElementById('branch-selection-page').classList.remove('hidden-view');
        document.getElementById('main-app-page').classList.add('hidden-view');
    }

    function renderAll() {
        const days = new Date(selectedYear - 543, selectedMonth, 0).getDate();
        document.getElementById('days-display').textContent = `${days} ‡∏ß‡∏±‡∏ô`;
        
        // Days Header 1-31
        let headerHtml = '<div class="flex">';
        for(let i=1; i<=31; i++) {
            headerHtml += `<div class="${i > days ? 'invisible' : ''} text-center text-[10px] w-[30px] border-r border-blue-400 py-2">${i}</div>`;
        }
        document.getElementById('days-header').innerHTML = headerHtml + '</div>';

        const tbody = document.getElementById('employee-tbody');
        tbody.innerHTML = employees.map((emp, idx) => {
            const stats = calculateStats(emp, days);
            const monthKey = `${selectedMonth}-${selectedYear}`;
            const shifts = emp.shifts?.[monthKey] || Array(31).fill('');
            
            let shiftCells = '<div class="flex">';
            for(let i=0; i<31; i++) {
                const s = shifts[i] || '';
                const cls = s === 'D' ? 'shift-d' : s === 'N' ? 'shift-n' : s === 'DN' ? 'shift-dn' : s === 'X' ? 'shift-x' : 'shift-empty';
                shiftCells += `<div onclick="toggleShift('${emp.id}', ${i})" class="${i >= days ? 'invisible' : ''} shift-cell ${cls} w-[30px]">${s}</div>`;
            }
            shiftCells += '</div>';

            return `<tr class="hover:bg-gray-50 bg-white">
                <td class="p-2 text-center font-bold text-gray-700">${idx + 1}</td>
                <td class="p-2 font-semibold text-blue-900">${emp.name}</td>
                <td class="p-2 text-gray-600">${emp.position} <span class="text-[9px] block text-blue-500">${emp.type === 'daily' ? '[‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô]' : '[‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô]'}</span></td>
                <td class="p-0 border-r">${shiftCells}</td>
                <td class="p-2 text-right">${fmt(emp.baseSalary)}</td>
                <td class="p-2 text-right text-gray-400 text-xs">${fmt(stats.dailyRate)}</td>
                <td class="p-2 text-center font-bold">${stats.units}</td>
                <td class="p-2 text-right font-bold text-blue-700 bg-blue-50">${fmt(stats.wage)}</td>
                <td class="p-2 text-right text-green-600">${fmt(emp.data?.[monthKey]?.ot)}</td>
                <td class="p-2 text-center text-red-600 font-bold">${stats.daysX}</td>
                <td class="p-2 text-right text-green-600">${fmt(emp.data?.[monthKey]?.com)}</td>
                <td class="p-2 text-right text-red-500">${fmt(emp.data?.[monthKey]?.hak)}</td>
                <td class="p-2 text-right font-bold text-white ${stats.net >= 0 ? 'bg-green-600' : 'bg-red-600'}">${fmt(stats.net)}</td>
                <td class="p-2 text-center">
                    <button onclick="deleteEmp('${emp.id}')" class="text-red-500 text-xs font-bold">‡∏•‡∏ö</button>
                </td>
            </tr>`;
        }).join('');
    }

    function calculateStats(emp, daysInMonth) {
        const monthKey = `${selectedMonth}-${selectedYear}`;
        const shifts = emp.shifts?.[monthKey] || [];
        let units = 0, daysX = 0;
        for(let i=0; i<daysInMonth; i++) {
            if(shifts[i] === 'D' || shifts[i] === 'N') units++;
            else if(shifts[i] === 'DN') units += 2;
            else if(shifts[i] === 'X') daysX++;
        }

        let dailyRate = 0;
        if(emp.type === 'daily') {
            dailyRate = emp.baseSalary; // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô = ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
        } else {
            dailyRate = emp.baseSalary / (daysInMonth - 4); // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = ‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏±‡∏Å 4 ‡∏ß‡∏±‡∏ô
        }

        const wage = units * dailyRate;
        const data = emp.data?.[monthKey] || { ot:0, com:0, hak:0 };
        const net = wage + (data.ot || 0) + (data.com || 0) - (data.hak || 0);
        return { units, daysX, dailyRate, wage, net };
    }

    function toggleShift(empId, dayIdx) {
        const emp = employees.find(e => e.id === empId);
        const monthKey = `${selectedMonth}-${selectedYear}`;
        if(!emp.shifts) emp.shifts = {};
        if(!emp.shifts[monthKey]) emp.shifts[monthKey] = Array(31).fill('');
        const cycle = ['', 'D', 'N', 'DN', 'X'];
        let cur = cycle.indexOf(emp.shifts[monthKey][dayIdx]);
        emp.shifts[monthKey][dayIdx] = cycle[(cur + 1) % cycle.length];
        save(); renderAll();
    }

    document.getElementById('add-employee-form').onsubmit = (e) => {
        e.preventDefault();
        employees.push({
            id: Date.now().toString(),
            name: document.getElementById('employee-name').value,
            position: document.getElementById('employee-position').value,
            type: document.getElementById('employee-type').value,
            baseSalary: parseFloat(document.getElementById('base-salary').value),
            shifts: {}, data: {}
        });
        e.target.reset(); save(); renderAll();
    };

    function save() { localStorage.setItem(getDBKey(currentBranch), JSON.stringify(employees)); }
    function deleteEmp(id) { if(confirm('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?')) { employees = employees.filter(e => e.id !== id); save(); renderAll(); } }
    function fmt(n) { return (n || 0).toLocaleString(undefined, { maximumFractionDigits: 0 }); }
  </script>
 </body>
</html>
